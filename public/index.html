<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>再生ページ</title>
</head>
<body style="background:#111;color:#fff;margin:0">

<video id="video" controls muted playsinline style="width:100%;height:auto;background:#000"></video>
<audio id="audio" style="display:none"></audio>

<script>
const videoEl = document.getElementById("video");
const audioEl = document.getElementById("audio");

// URLパラメータから動画IDを取得
const params = new URLSearchParams(window.location.search);
const videoId = params.get("id");

if (!videoId) {
  alert("動画IDが指定されていません");
} else {
  async function load() {
    try {
      // 外部動画URL取得APIにアクセス（プロキシ経由）
      const res = await fetch(`/proxy?url=${encodeURIComponent('https://teaching-materials-r4zf.onrender.com/video?id=' + videoId)}`);
      const data = await res.json();

      if (!data.video || !data.audio) {
        console.error("動画または音声URLがありません", data);
        return;
      }

      // プロキシ経由で動画/音声をセット
      videoEl.src = `/proxy?url=${encodeURIComponent(data.video)}`;
      audioEl.src = `/proxy?url=${encodeURIComponent(data.audio)}`;

      // video 再生時に audio も同期
      videoEl.addEventListener("play", () => audioEl.play());
      videoEl.addEventListener("pause", () => audioEl.pause());
      videoEl.addEventListener("seeking", () => audioEl.currentTime = videoEl.currentTime);
      videoEl.addEventListener("ratechange", () => audioEl.playbackRate = videoEl.playbackRate);

      // 自動再生（ミュート必須）
      videoEl.play();

    } catch (err) {
      console.error("動画ロード中にエラー", err);
    }
  }

  load();
}
</script>

</body>
</html>
